"use strict";var $=jQuery.noConflict(),state=history.state||{filters:{},search:[],page:0,size:1};function buildCatalogue(e){$(".table-list").empty(),$("#nav-catalogue").hide();var a=e.result;if(state.size=Math.ceil(a.count/config.datasetsPerPage),0!=a.results.length){for(var t={Document:"fa-newspaper-o",Map:"fa-map-o",Table:"fa-area-chart",Website:"fa-desktop"},s=0;s<a.results.length;s++){for(var i=a.results[s],l=i.resource_formats.split(" "),n="",r=0;r<l.length;r++)n+="<li class="+l[r].toLowerCase()+">"+l[r]+"</li>";var c='<div class="row"><div class="col-md-8"><h2><a href="/package/'+i.name+'">'+i.title+"</a></h2>"+i.excerpt+'<div class="formats-available"><h3 class="sr-only">Formats Available for '+i.title+'</h3><ul class="tag-list">'+n+'</ul></div></div><div class="col-md-4 text-right attributes"><p><span class="sr-only">Last Updated: </span>'+getFullDate(i.published_date.split("-"))+'&nbsp; <span class="fa fa-clock-o" aria-hidden="true"></span></p><p><span class="sr-only">Data Type: </span>'+i.dataset_category+'&nbsp; <span class="fa '+t[i.dataset_category]+'" aria-hidden="true"></span></p></div></div>';$(".table-list").append(c)}if(a.count>config.datasetsPerPage){$("#nav-catalogue .page-remove").remove();for(s=0;s<state.size;s++){var o=s+1+"",f=s==state.page?" active":"";0==s||s==state.size-1||Math.abs(state.page-s)<=2?$("#nav-catalogue li:last-child").before('<li class="page-item page-remove'+f+'"><a class="page-link" href="#" aria-label="Go to page '+o+'" data-page='+s+">"+o+"</a></li>"):3==Math.abs(state.page-s)&&$("#nav-catalogue li:last-child").before('<li class="page-item page-remove disabled"><a class="page-link" href="#" aria-label="...">...</a></li>')}$("#nav-catalogue .page-remove a").on("click",function(e){e.preventDefault(),state.page=$(this).data("page"),$(this).addClass("active"),loadCatalogue()}),$("#nav-catalogue").show()}}else $(".table-list").append('<div class="row"><div class="col-md-12"><h2>No datasets found </h2></div></div>')}function buildCatalogueSidebar(e){$(".filter ul, .filter select").empty();var a=e.result;for(var t in a.search_facets){var s=a.search_facets[t],i={};for(var l in s.items){var n=s.items[l];if(-1!==["resource_formats"].indexOf(s.title)){var r=n.name.split(" ");for(var c in r)void 0===i[r[c]]?i[r[c]]={count:n.count,name:r[c]}:i[r[c]].count+=n.count}else i[n.name]={count:n.count,name:n.name}}for(var t in(i=Object.keys(i).map(function(e){return i[e]})).sort(function(e,a){return a.count==e.count?e.name<a.name?-1:1:a.count-e.count}),i){var o=i[t],f=state.filters[s.title],d=" ",g=" ";-1!==config.filters.dropdowns.indexOf(s.title)?(null!=f&&-1!==f.indexOf(o.name)&&(d+='selected="selected" '),$(".filter-"+s.title+" select").append("<option"+d+'data-field="'+s.title+'" value="'+o.name+'">'+o.name+"</option>")):-1!==config.filters.checkboxes.indexOf(s.title)&&(null!=f&&-1!==f.indexOf(o.name)&&(d+='checked="true" ',g+='class="checkbox-checked" '),$(".filter-"+s.title+" ul").append('<li class="checkbox checkbox-filter"><label'+g+'><input type="checkbox"'+d+'data-field="'+s.title+'" value="'+o.name+'">&nbsp;'+o.name+"&nbsp;<small>("+o.count+")</small></label></li>"))}}if(0<state.search.length)for(var t in state.search){o=state.search[t];$(".filter-search select").prepend('<option selected="selected" value="'+o+'">'+o+"</option>")}config.isInitializing&&buildStaticUI(),buildDynamicUI()}$.extend(config,{isInitializing:!0,cataloguePages:0,datasetsPerPage:10,filters:{checkboxes:["dataset_category","resource_formats"],dropdowns:["owner_division","vocab_tags"],filters:["dataset_category","owner_division","resource_formats","vocab_tags"]},select2:{language:{noResults:function(){return"Start typing search term..."}},width:"100%"}});var buildStaticUI=function(){$("#nav-catalogue .page-keep a").on("click",function(){switch($(this).data("page")){case"previous":state.page-=1;break;case"next":state.page+=1}loadCatalogue()}),$("#select-division, #select-vocab_tags").select2(config.select2),$("#select-search").select2($.extend({},config.select2,{tags:!0})),config.isInitializing=!1,$(".block-hidden").fadeIn(250)};function buildDynamicUI(){switch(state.page){case 0:$("#nav-catalogue .page-keep").first().addClass("disabled"),$("#nav-catalogue .page-keep").last().removeClass("disabled");break;case state.size-1:$("#nav-catalogue .page-keep").last().addClass("disabled"),$("#nav-catalogue .page-keep").first().removeClass("disabled");break;default:$("#nav-catalogue .page-keep").removeClass("disabled")}$(".select-select2").on("change.select2",function(){var e=$(this).val();$(this).is("#select-search")?state.search=e||[]:state.filters[$(this).data("field")]=e,state.page=0,loadCatalogue()}),$(".checkbox-filter input").on("click",function(){$(this).parent("label").toggleClass("checkbox-checked");var t=$(this).data("field");state.filters[t]=[],$.each($('[data-field="'+t+'"]:checked'),function(e,a){state.filters[t].push($(a).val())}),state.page=0,loadCatalogue()})}function loadCatalogue(){if(config.isInitializing||!(state.page<0||state.page>=state.size)){var e=config.isInitializing?parseParams():parseFilters(),a={q:e,rows:config.datasetsPerPage,sort:"name asc",start:state.page*config.datasetsPerPage},t=[];0!=state.page&&t.push("n="+state.page),0<e.length&&t.push("q="+encodeURI(e)),0<state.search.length&&t.push("r="+encodeURI(state.search.join("+"))),loadCatalogueSidebar(e),getCKAN("package_search",a,buildCatalogue),history.replaceState(null,"","/catalogue/?"+t.join("&"))}}function loadCatalogueSidebar(e){var a={q:e,rows:0,facet:"on","facet.limit":-1,"facet.field":JSON.stringify(config.filters.filters)};getCKAN("package_search",a,buildCatalogueSidebar)}function parseFilters(){var e=[];for(var t in state.filters)if(null!=state.filters[t]&&state.filters[t].length){var s={};if(-1!==config.filters.checkboxes.indexOf(t)){var a=[];for(var i in state.filters[t])a.push("*"+state.filters[t][i]+"*");s[t]=[t+":("+a.join(" OR ")+")"]}else-1!==config.filters.dropdowns.indexOf(t)&&(s[t]=[],$.each(state.filters[t],function(e,a){s[t].push(t+':"'+a+'"')}));for(var l in s)e.push("("+s[l].join(" OR ")+")")}if(null!=state.search&&0<state.search.length){var n=[];for(var r in state.search)n=n.concat(state.search[r].split(" "));n=n.map(function(e){return"*"+e+"*"}).join(" AND "),e.push("(excerpt: ("+n+")) OR (title: ("+n+"))")}return e.join(" AND ")}function parseParams(){var e=["n","q","r"];for(var a in e){var t=getURLParam(e[a]);if(null!=t)switch(e[a]){case"n":state.page=parseInt(t);break;case"q":t=t.split(" AND ").map(function(e){return e.substring(1,e.length-1).split(":")}),$.each(t,function(e,a){-1!==config.filters.filters.indexOf(a[0])&&(state.filters[a[0]]=a[1].replace(/[*/(/)""]/g,"").split(" OR "))});break;case"r":state.search=t.split("+")}}return getURLParam("q")||""}function init(){$(".block-hidden").hide(),loadCatalogue()}